#:kivy 2.1.0

# ====== JANELA DE CONFIGURAÇÕES DE CONEXÃO ========== #
<ModBusPopup>:
    title: "CONFIGURAÇÕES MODBUS"
    bold: True
    background_color: 0, 0, 0, 0
    size_hint: None, None
    height: 300
    width: 400      

    #BoxLayout Pai
    BoxLayout:
        id: layout                       # ID fundamental para popups.py conseguir inserir a Label de erro aqui
        orientation: 'vertical'
        padding: 15
        spacing: 10
        canvas.before:
            Color:
                rgba: 0.788, 0.780, 0.780, 1            #cor cinza igual da planta base
            Rectangle:
                pos: self.pos
                size: self.size

        # CAMPOS IP E PORTA
        GridLayout:                                    
            cols: 2
            rows: 2
            size_hint_y: None
            height: 110
            spacing: 10

            Label:
                text: "IP"
                bold: True
                color: 0, 0, 0, 1
                font_size: 18

            TextInput:
                id: txt_ip
                text: "10.15.30.182"
                font_size: 18
                color: 0, 0, 0, 1
                halign: 'center'
                valign: 'middle'
                background_normal: ''
                background_active: ''
                background_color: 0.788, 0.780, 0.780, 1

            Label:
                text: "Porta"
                bold: True
                color: 0, 0, 0, 1
                font_size: 18

            TextInput:
                id: txt_port                    # ID usado pelo Python para ler a porta digitada
                text: "502"
                font_size: 18
                color: 0, 0, 0, 1
                halign: 'center'
                valign: 'middle'
                background_normal: ''
                background_active: ''
                background_color: 0.788, 0.780, 0.780, 1

        # BOTÕES CONECTAR E FECHAR -> Usam formato arredondado (widgets_auxiliares)
        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: 60
            spacing: 20

            Widget:                 #espaçador

            RoundedButton:
                text: "Conectar"
                size_hint: None, None
                size: self.texture_size[0] + 40, 45
                on_release:
                    root.clearInfo() # Limpa avisos de erros de tentativas anteriores
                    # Chama a função de conexão no widget principal passando os valores dos inputs
                    app.root.startDataRead(txt_ip.text, int(txt_port.text))

            RoundedButton:
                text: "Fechar"
                size_hint: None, None
                size: self.texture_size[0] + 40, 45
                on_release: 
                    root.dismiss() # Fecha a janela do popup
                    root.clearInfo() # Limpa a mensagem de erro ao sair

            Widget:             #espaçador
        
<ScanPopup>:
    title: "Configuração ScanTime"
    size_hint_y: None
    size_hint_x: 0.3
    height: 250

    BoxLayout:
        id: layout
        orientation: 'vertical'
        GridLayout:
            cols: 2
            rows: 1
            Label:
                text: "ScanTime[ms]"
                font_size: 14
            TextInput:
                id: txt_st
                text: "127.0.0.1"
                font_size: 14
                halign: 'center'
                valign: 'middle'
        BoxLayout:
            orientation: 'horizontal'
            Button:
                text: "Configurar"
                size_hint_y: None
                height: 40
                on_release:
                    root.dismiss() #fecha a janela e volta pra raiz
            Button:
                text: "Fechar"
                size_hint_y: None
                height: 40
                on_release: 
                    root.dismiss() #fecha a janela e volta pra raiz


# ====== JANELA DE COMANDOS DO MOTOR ========== #
<ComandoPopup>:
    title: "COMANDOS DE PARTIDA DO MOTOR"
    size_hint: None, None
    width: 970
    height: 500
    background_color: 0, 0, 0, 0

    BoxLayout:                          # BoxLayout Pai
        orientation: 'vertical'
        size_hint: 1, 1

        BoxLayout:                      # BoxLayout com as colunas
            orientation: 'horizontal'
            size_hint: 1, 0.8
            canvas.before:
                Color:
                    rgba: 0.788, 0.780, 0.780, 1
                Rectangle:
                    pos: self.pos
                    size: self.size

            # PRIMEIRA COLUNA: TIPOS DE PARTIDA
            BoxLayout:
                orientation: 'vertical'
                size_hint_x: 0.3
                padding: 15
                spacing: 15

                Label:
                    text: "SELECIONE TIPO\nDA PARTIDA"
                    bold: True
                    color: 0, 0, 0, 1
                    font_size: 18
                    halign: 'center'
                    valign: 'middle'
                    text_size: self.size

                BoxLayout:
                    orientation: 'vertical'
                    spacing: 12
                    size_hint_y: 0.8

                    RoundedButton:
                        text: "TESYS DIRETA"
                        pos_hint: {"center_x": 0.5}
                        size_hint_x: 1
                        on_release:
                            app.root.selecionar_partida(3)
                            root.trocar_tela("tesysDireta")

                    RoundedButton:
                        text: "ATV31 INVERSOR"
                        pos_hint: {"center_x": 0.5}
                        size_hint_x: 1
                        on_release:
                            app.root.selecionar_partida(2)
                            root.trocar_tela("atv31")

                    RoundedButton:
                        text: "ATS48 SOFT-START"
                        pos_hint: {"center_x": 0.5}
                        size_hint_x: 1
                        on_release:
                            app.root.selecionar_partida(1)
                            root.trocar_tela("ats48")

            # SEGUNDA COLUNA: CONFIGURAÇÃO DO TIPO DE PARTIDA
            BoxLayout:
                size_hint_x: 0.3
                padding: 10

                ScreenManager:
                    id: screenTipoPartida

                    TesysDiretaScreen:
                        name: "tesysDireta"

                    ATS48Screen:
                        name: "ats48"

                    ATV31Screen:
                        name: "atv31"

                    VaziaScreen:
                        name: "vazia"

        # BOTÃO FECHAR
        BoxLayout:
            size_hint: 1, 0.2
            padding: [0, 15, 0, 20]
            canvas.before:
                Color:
                    rgba: 0.788, 0.780, 0.780, 1
                Rectangle:
                    pos: self.pos
                    size: self.size

            Widget:

            RoundedButton:
                text: "Fechar"
                size_hint: None, None
                size: self.texture_size[0] + 40, 45
                pos_hint: {"center_x": 0.5}
                on_release: root.dismiss()

            Widget:

# SCREENS PARA TIPO DE PARTIDA NO MOTOR =================
# 1) SOFT-START SCREEN
<ATS48Screen@Screen>:     
    BoxLayout:
        orientation: 'vertical'
        spacing: 15
        padding: 20

        Label:
            text: "ATS48 - Soft Starter"
            size_hint:1, 0.2
            bold: True
            color: 0, 0, 0, 1
            halign: 'center'
            valign: 'middle'
            font_size: 18
        Label:
            text: "Digite os parâmetros de\naceleração e desaceleração:"
            size_hint:1, 0.1
            bold: False
            color: 0, 0, 0, 1
            halign: 'center'
            valign: 'middle'
            font_size: 18
        Label:
            text: "MIN:10s e MAX:60s"
            size_hint:1, 0.1
            bold: True
            color: 0, 0, 0, 1
            halign: 'center'
            valign: 'middle'
            font_size: 16

        GridLayout:                 #grifLayout para entrada de ACC/DCC
            cols: 2
            spacing: 10
            size_hint:1, 0.6

            Label:
                text: "ACC"
                color: 0, 0, 0, 1
            TextInput:
                text: "10"
                color: 0, 0, 0, 1
                multiline: False

            Label:
                text: "DCC"
                color: 0, 0, 0, 1
            TextInput:
                text: "10"
                color: 0, 0, 0, 1
                multiline: False

# TELA VAZIA SCREEN
<VaziaScreen@Screen>:
    BoxLayout:
        orientation: 'vertical'
        spacing: 15
        padding: 20

        Label:
            text: "CONFIGURAÇÃO DO \nTIPO DE PARTIDA"
            color: 0, 0, 0, 1
            bold: True
            halign: 'center'
            valign: 'middle'
            font_size: 18
            text_size: self.size
        Label:
            text: "Nenhum tipo de \n  partida selecionado"
            color: 0, 0, 0, 1
            halign: 'center'
            valign: 'middle'
            text_size: self.size
            font_size: 16

# TESYS DIRETA SCREEN
<TesysDiretaScreen@Screen>:
    BoxLayout:
        Label:
            text: "TESYS Direta \nselecionada"
            color: 0, 0, 0, 1
            halign: 'center'
            valign: 'middle'
            font_size: 18

# ATV31 SCREEN
<ATV31Screen@Screen>:
    BoxLayout:
        orientation: 'vertical'
        spacing: 15
        padding: 20

        Label:
            text: "ATV31 - Inversor"
            color: 0, 0, 0, 1
            bold: True
            font_size: 18

        Label:
            text: "Velocidade (Hz)"
            color: 0, 0, 0, 1

        Slider:
            id: vel_slider
            min: 0
            max: 60
            value: 0
            on_touch_up:
                app.root.set_vel_inversor(self.value)

        Label:
            text: f"{int(vel_slider.value)} Hz"
            color: 0, 0, 0, 1


# ====== JANELA DE TEMPERATURA DO MOTOR ========== #
<TemperaturaPopup>:
    title: "TEMPERATURAS DO MOTOR"
    bold: True
    background_color: 0, 0, 0, 0
    size_hint: None, None
    width: 400      
    height: 250

    BoxLayout:
        orientation: 'vertical'
        padding: 10
        spacing: 10

        canvas.before:
            Color:
                rgba: 0.788, 0.780, 0.780, 1
            Rectangle:
                pos: self.pos
                size: self.size

        Widget:   # espaçador superior

        # CARCAÇA 
        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: 40

            Label:
                text: "Carcaça"
                bold: True
                font_size: 18
                color: 0, 0, 0, 1
                size_hint_x: 0.5
                halign: 'right'
                valign: 'middle'
                text_size: self.size

            Widget:         #espaçador

            Label:
                id: temp_carcaca
                text: "-.- °C"
                font_size: 18
                color: 0, 0, 0, 1
                size_hint_x: 0.5
                halign: 'left'
                valign: 'middle'
                text_size: self.size

        Widget:   # espaçador entre texto e botão

        # BOTÃO FECHAR
        BoxLayout:
            size_hint_y: None
            height: 45

            Widget:   #espaçador

            RoundedButton:
                text: "Fechar"
                size_hint: None, None
                size: self.texture_size[0] + 40, 40
                pos_hint: {"center_x": 0.5}
                on_release: root.dismiss()

            Widget:

        Widget:   # espaçador 


# ====== JANELA DE MEDIDAS ========== #
<MedidasPopup>:
    title: "MEDIDAS ELÉTRICAS"
    bold: True
    background_color: 0, 0, 0, 0
    size_hint: None, None
    width: 650
    height: 600

    BoxLayout:                          #BoxLayou Pai
        orientation: 'vertical'
        padding: 10
        spacing: 10

        canvas.before:
            Color:
                rgba: 0.788, 0.780, 0.780, 1
            Rectangle:
                pos: self.pos
                size: self.size

        # GRID PRINCIPAL =================
        GridLayout:
            cols: 2
            rows: 2
            spacing: 3

            # TENSÃO 
            BoxLayout:
                orientation: 'vertical'
                spacing: 5

                Label:
                    text: "Tensão"
                    bold: True
                    color: 0, 0, 0, 1
                    font_size: 18
                    size_hint_y: None
                    height: 30
                    canvas.after:
                        Color:
                            rgba: 0, 0, 0, 0.6
                        Line:
                            points: self.x, self.y, self.right, self.y
                            width: 1.2

                GridLayout:
                    cols: 2
                    row_default_height: 30
                    row_force_default: True

                    Label:
                        text: "R–S"
                        color: 0, 0, 0, 1
                    LabelTHD:
                        id: ddp_rs

                    Label:
                        text: "S–T"
                        color: 0, 0, 0, 1
                    LabelTHD:
                        id: ddp_st

                    Label:
                        text: "T–R"
                        color: 0, 0, 0, 1
                    LabelTHD:
                        id: ddp_tr

            # CORRENTE 
            BoxLayout:
                orientation: 'vertical'
                spacing: 5

                Label:
                    text: "Corrente"
                    bold: True
                    color: 0, 0, 0, 1
                    font_size: 18
                    size_hint_y: None
                    height: 30
                    canvas.after:
                        Color:
                            rgba: 0, 0, 0, 0.6
                        Line:
                            points: self.x, self.y, self.right, self.y
                            width: 1.2

                GridLayout:
                    cols: 2
                    row_default_height: 30
                    row_force_default: True

                    Label:
                        text: "Fase R"
                        color: 0, 0, 0, 1
                    LabelValorCorrente:
                        id: corr_r

                    Label:
                        text: "Fase S"
                        color: 0, 0, 0, 1
                    LabelValorCorrente:
                        id: corr_s

                    Label:
                        text: "Fase T"
                        color: 0, 0, 0, 1
                    LabelValorCorrente:
                        id: corr_t

                    Label:
                        text: "Neutro"
                        color: 0, 0, 0, 1
                    LabelValorCorrente:
                        id: corr_neutro

                    Label:
                        text: "Média"
                        color: 0, 0, 0, 1
                    LabelValorCorrente:
                        id: corr_media

            # DEMANDA
            BoxLayout:
                orientation: 'vertical'
                spacing: 5

                Label:
                    text: "Demanda"
                    bold: True
                    color: 0, 0, 0, 1
                    font_size: 18
                    size_hint_y: None
                    height: 30
                    canvas.after:
                        Color:
                            rgba: 0, 0, 0, 0.6
                        Line:
                            points: self.x, self.y, self.right, self.y
                            width: 1.2

                GridLayout:
                    cols: 2
                    row_default_height: 30
                    row_force_default: True

                    Label:
                        text: "Anterior"
                        color: 0, 0, 0, 1
                    LabelValorDemanda:
                        id: dem_anterior

                    Label:
                        text: "Atual"
                        color: 0, 0, 0, 1
                    LabelValorDemanda:
                        id: dem_atual

                    Label:
                        text: "Média"
                        color: 0, 0, 0, 1
                    LabelValorDemanda:
                        id: dem_media

                    Label:
                        text: "Prevista"
                        color: 0, 0, 0, 1
                    LabelValorDemanda:
                        id: dem_prevista

            # POTÊNCIA 
            BoxLayout:
                orientation: 'vertical'
                spacing: 5

                Label:
                    text: "Potência"
                    bold: True
                    color: 0, 0, 0, 1
                    font_size: 18
                    size_hint_y: None
                    height: 30
                    canvas.after:
                        Color:
                            rgba: 0, 0, 0, 0.6
                        Line:
                            points: self.x, self.y, self.right, self.y
                            width: 1.2

                GridLayout:                 #grid para colocar potencia ativa, reativa e FP
                    cols: 2
                    spacing: 10

                    # -------- ATIVA --------
                    BoxLayout:
                        orientation: 'vertical'
                        spacing: 5

                        Label:
                            text: "Ativa"
                            bold: True
                            color: 0, 0, 0, 1
                            size_hint_y: None
                            height: 25
                            canvas.after:
                                Color:
                                    rgba: 0, 0, 0, 0.6
                                Line:
                                    points: self.x, self.y, self.right, self.y
                                    width: 1.2

                        GridLayout:
                            cols: 2
                            row_default_height: 30
                            row_force_default: True
                            id: pot_ativa

                            Label:
                                text: "R"
                                color: 0, 0, 0, 1
                            LabelValorPotAtiva:
                                id: pot_ativa_r

                            Label:
                                text: "S"
                                color: 0, 0, 0, 1
                            LabelValorPotAtiva:
                                id: pot_ativa_s

                            Label:
                                text: "T"
                                color: 0, 0, 0, 1
                            LabelValorPotAtiva:
                                id: pot_ativa_t

                    # -------- Reativa, Aparente e FP --------
                    BoxLayout:
                        orientation: 'vertical'
                        spacing: 5

                        Label:
                            text: "Reativa"
                            bold: True
                            color: 0, 0, 0, 1
                        Label:
                            id: pot_reativa_total
                            text: "-.- var"
                            color: 0, 0, 0, 1

                        Label:
                            text: "Aparente"
                            bold: True
                            color: 0, 0, 0, 1
                        Label:
                            id: pot_aparente_total
                            text: "-.- VA"
                            color: 0, 0, 0, 1

                        Label:
                            text: "FP"
                            bold: True
                            color: 0, 0, 0, 1
                        Label:
                            id: fp_total
                            text: "-.-"
                            color: 0, 0, 0, 1
        # Frequencia   
        # BoxLayout:
        #     size_hint_y: None
        #     height: 30 
        #     Label:
        #         text: "Frequência"
        #         color: 0, 0, 0, 1
        #     Label:
        #         id: freq_rede
        #         text: "-.- Hz"
        #         color: 0, 0, 0, 1

        # Frequência
        GridLayout:
            cols: 2
            size_hint_y: None
            height: 30
            spacing: 30

            Label:
                text: "Frequência"
                bold: True
                color: 0, 0, 0, 1
                halign: 'right'
                text_size: self.size

            Label:
                id: freq_rede
                text: "-.- Hz"
                color: 0, 0, 0, 1
                halign: 'left'
                text_size: self.size

        # BOTÃO FECHAR 
        BoxLayout:
            size_hint_y: None
            height: 60

            Widget:

            RoundedButton:
                text: "Fechar"
                size_hint: None, None
                size: self.texture_size[0] + 40, 45
                pos_hint: {"center_x": 0.5}
                on_release: root.dismiss()

            Widget:


# ====== GRÁFICOS DAS VARIAVEIS PRINCIPAIS  ========== # 
# Será um popup por cada variavel!!

<DataGraphPopup>:
    title: "GRÁFICO"
    bold: True
    background_color: 0, 0, 0, 0
    BoxLayout:
        orientation:'vertical'
        canvas.before:
            Color:
                rgba: 0.5,0.5,0.5,0.5
            Rectangle:
                pos: self.pos
                size: self.size
        TimeSeriesGraph:
            id: graph
            xlabel: 'Horário'
            background_color: 0.5,0.5,0.5,1
            x_ticks_minor: 1        #subdivisões do eixo horizontal
            x_ticks_major: 5        #grid
            y_ticks_major: 5 
            y_grid_label: True
            x_grid_label: True
            padding: 5              #espaçamento entre os labels
            x_grid: True
            y_grid: True 
            xmin: 0
            ymin: 0
            ymax: 100
        BoxLayout:
            orientation:'horizontal'
            size_hint:(1,0.05)
            BoxLayout:
                orientation: 'horizontal'
                size_hint: (0.7,1)
                Label:
                    size_hint: (0.3,1) 
                    text:'Número de pontos do gráfico'
                LabelCheckBoxDataGraph:
                    id: mp20
                    on_kv_post:
                        self.ids.label.text = '20' 
                        self.ids.checkbox.group = 'cd_group' 
                        self.ids.checkbox.active = True 
                LabelCheckBoxDataGraph:
                    id: mp50
                    on_kv_post:
                        self.ids.label.text = '50' 
                        self.ids.checkbox.group = 'cd_group'
                LabelCheckBoxDataGraph:
                    id: mp100
                    on_kv_post:
                        self.ids.label.text = '100' 
                        self.ids.checkbox.group = 'cd_group'
            BoxLayout:
                orientation: 'horizontal'
                size_hint: (0.3,1)
                Widget:
                RoundedButton:
                    text: 'Fechar'
                    size_hint: (1, 0.8)
                    on_release: root.dismiss()
                Widget:


<LabelCheckBoxDataGraph>:
    orientation: 'horizontal'
    size_hint: (0.1,1)
    CheckBox:
        id: checkbox
        on_active: root.update_graph_points(self.active)
    Label:
        id: label

# =================== BD ================#
<BancoDadosPopup>:
    title: "BANCO DE DADOS"
    bold: True
    background_color: 0, 0, 0, 0
    BoxLayout:
        orientation: 'vertical'
        TimeSeriesGraph:
            id: graph_bd
            xlabel: 'Horário'
            ylabel: 'Medicoes'
            background_color: 0.5, 0.5, 0.5, 1
            x_ticks_minor: 1
            x_ticks_major: 5
            y_ticks_major: 10
            y_grid_label: True
            x_grid_label: True
            padding: 5
            x_grid: True
            y_grid: True
            xmin: 0
            ymin: 0
            ymax: 100
        BoxLayout:
            id: sensores
            orientation: 'horizontal'
            size_hint: (1, 0.1)
            Spinner:
                id: dropdown
                text: "pressao_reservatorio"  # seleciona a pressão do reservatório por padrão
                values: ["pressao_reservatorio", "vazao_valvulas", "torque_motor", "vel_motor", "temp_carcaca", "freq_rede", "ddp_rs", "ddp_st", "ddp_tr", "corr_r", "corr_s", "corr_t", "corr_media", "corr_neutro", "pot_ativa_r", "pot_ativa_s", "pot_ativa_t", "pot_ativa_total", "pot_reativa_total", "pot_aparente_total", "dem_anterior", "dem_atual", "dem_media", "dem_prevista", "fp_total"]
                on_text: root.plotar_grafico()

        BoxLayout:
            orientation: 'horizontal'
            size_hint: (1, 0.1)
            Label:
                text: 'Timestamp inicial \r\n [size=12] (DD/MM/AAAA HH:MM:SS) [/size]'
                halign: 'center'
                markup: True
            TextInput:
                id: txt_init_time
                size_hint: (1, 0.8)
                halign: 'center'
                valign: 'middle'
                multiline: False
            Label:
                text: 'Timestamp final \r\n [size=12] (DD/MM/AAAA HH:MM:SS) [/size]'
                halign: 'center'
                markup: True
            TextInput:
                id: txt_final_time
                size_hint: (1, 0.8)
                halign: 'center'
                valign: 'middle'
                multiline: False
            BoxLayout:
                orientation: 'horizontal'
                Widget:
                RoundedButton:
                    text: 'Fechar'
                    size_hint: (1, 0.8)
                    on_release: root.dismiss()
                Widget:
